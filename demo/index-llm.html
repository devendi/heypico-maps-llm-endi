<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panduan Rekomendasi Tempat oleh AI</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
      --slate-900: #0f172a;
      --slate-700: #334155;
      --slate-500: #64748b;
      --indigo-600: #4f46e5;
      --indigo-500: #6366f1;
      --indigo-100: #e0e7ff;
      --surface: rgba(255, 255, 255, .9);
    }

    body {
      margin: 0;
      min-height: 100vh;
      padding: clamp(1.5rem, 4vw, 3rem) 1rem 4rem;
      display: flex;
      justify-content: center;
      background: radial-gradient(circle at 10% -10%, rgba(79, 70, 229, .18), transparent 55%),
                  radial-gradient(circle at 90% 0%, rgba(14, 165, 233, .12), transparent 50%),
                  #f8fafc;
    }

    .hero {
      display: grid;
      gap: .75rem;
      text-align: center;
    }

    main {
      width: min(960px, 100%);
      background: var(--surface);
      border-radius: 26px;
      border: 1px solid rgba(255, 255, 255, .65);
      padding: clamp(1.75rem, 4vw, 2.75rem);
      box-shadow: 0 30px 60px rgba(15, 23, 42, .12);
      backdrop-filter: blur(8px);
      display: grid;
      gap: 1.5rem;
    }
    
    h1 {
      margin: 0;
      font-weight: 700;
      font-size: clamp(1.65rem, 3.4vw, 2.25rem);
      letter-spacing: -.01em;
      color: var(--slate-900);
    }

    .hero p {
      margin: 0 auto;
      max-width: 540px;
      color: var(--slate-500);
      line-height: 1.55;
      font-size: 1.02rem;
    }

    form {
      display: grid;
      gap: 1rem;
      padding: clamp(1.25rem, 3vw, 1.75rem);
      border: 1px solid rgba(79, 70, 229, .14);
      border-radius: 18px;
      background: rgba(255, 255, 255, .88);
    }

    label {
      display: grid;
      gap: .35rem;
      font-weight: 600;
      color: var(--slate-700);
    }

    label span {
      font-weight: 500;
      color: var(--slate-500);
      font-size: .95rem;
    }

    textarea {
      min-height: 130px;
      padding: .85rem .95rem;
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, .12);
      font-size: 1rem;
      resize: vertical;
      transition: border-color 140ms ease, box-shadow 140ms ease;
    }
    textarea:focus {
      outline: none;
      border-color: rgba(99, 102, 241, .6);
      box-shadow: 0 0 0 3px rgba(129, 140, 248, .24);
    }

    .actions-bar {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      justify-content: space-between;
      align-items: center;
    }
    

    .hint {
      margin: 0;
      font-size: .9rem;
      color: var(--slate-500);
    }

    button[type="submit"] {
      padding: .8rem 1.9rem;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      font-size: 1rem;
      color: #fff;
      background: linear-gradient(120deg, var(--indigo-600), var(--indigo-500));
      cursor: pointer;
      transition: transform 140ms ease, box-shadow 140ms ease;
    }

    button[type="submit"]:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(79, 70, 229, .25);
    }

    .message {
      padding: 1rem 1.1rem;
      border-radius: 16px;
      background: rgba(99, 102, 241, .08);
      color: var(--slate-700);
      font-size: .98rem;
      line-height: 1.45;
    }

    .message[hidden] { display: none; }

    .intent {
      border-radius: 18px;
      border: 1px solid rgba(79, 70, 229, .16);
      background: rgba(99, 102, 241, .07);
      padding: 1.35rem;
      display: grid;
      gap: .75rem;
      font-size: .97rem;
    }

    .intent[hidden] { display: none; }

    .intent h2 {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--slate-700);
    }

    .intent-intro {
      margin: 0;
      color: var(--slate-500);
      line-height: 1.5;
    }

    .intent-row {
      display: grid;
      gap: .25rem;
    }

    .intent-row strong {
      font-weight: 600;
      color: var(--slate-700);
    }

    .intent-row small {
      color: var(--slate-500);
      font-size: .84rem;
      line-height: 1.45;
    }
    
    .intent-link {
      color: var(--indigo-600);
      text-decoration: none;
      font-weight: 600;
    }
    .intent-link:hover { text-decoration: underline; }

    .results {
      display: grid;
      gap: 1.35rem;
    }

    .card {
      padding: 1.25rem;
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, .08);
      background: #fff;
      box-shadow: 0 20px 38px rgba(15, 23, 42, .08);
      display: grid;
      gap: .9rem;
    }

    .card h3 {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 650;
      color: var(--slate-900);
    }

    .info {
      margin: 0;
      color: var(--slate-500);
      font-size: .96rem;
      line-height: 1.55;
    }

    .map-frame {
      position: relative;
      width: 100%;
      padding-top: 56.25%;
      border-radius: 16px;
      overflow: hidden;
      background: rgba(15, 23, 42, .05);
    }

    .map-frame iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }

    .card-actions {
      display: flex;
      flex-wrap: wrap;
      gap: .6rem;
      justify-content: flex-end;
    }

    .map-button {
      padding: .6rem 1.3rem;
      border-radius: 12px;
      border: 1px solid rgba(99, 102, 241, .22);
      background: rgba(99, 102, 241, .12);
      color: var(--indigo-600);
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: .35rem;
    }

    .map-button:hover { background: rgba(99, 102, 241, .18); }

    footer {
      text-align: center;
      color: var(--slate-500);
      font-size: .85rem;
    }

    @media (max-width: 680px) {
      main { padding: 1.5rem; }
      form { padding: 1rem; }
      .actions-bar { flex-direction: column; align-items: stretch; }
      button[type="submit"] { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <main>
    
    <header class="hero">
      <h1>Panduan Rekomendasi Tempat oleh AI</h1>
      <p>
        Jelaskan tujuan Anda secara singkat, lalu biarkan AI merangkum kebutuhan dan memberikan rekomendasi terdekat.
        Lokasi perangkat Anda aman karena hanya dipakai secara lokal untuk menghitung jarak.
      </p>
    </header>

    <form id="prompt-form">
      <label for="prompt">
        Tulis kebutuhan Anda
        <span>Contoh: "Cari coffee shop nyaman untuk kerja jarak &lt; 3 km dari posisi saya"</span>
      </label>
      <textarea id="prompt" name="prompt" placeholder="Ceritakan kebutuhan atau rencana Anda di sini" required></textarea>
      <div class="actions-bar">
        <p class="hint">Tips: sebutkan jenis tempat, suasana yang diinginkan, serta preferensi jarak.</p>
        <button type="submit">Tanyakan ke AI</button>
      </div>
    </form>

    <div id="feedback" class="message" hidden></div>
    <section id="intent" class="intent" hidden></section>
    <section id="results" class="results" aria-live="polite"></section>

    <footer>
      Gunakan hasil sebagai panduan awal. Periksa kembali informasi penting sebelum berkunjung.
    </footer>

  </main>

  <script>
    const API_BASE = "http://127.0.0.1:8000";

    const form = document.getElementById('prompt-form');
    const promptField = document.getElementById('prompt');
    const resultsContainer = document.getElementById('results');
    const feedback = document.getElementById('feedback');
    const intentBox = document.getElementById('intent');
    const numberFormatter = new Intl.NumberFormat('id-ID');

    const setFeedback = (msg, show = true) => {
      feedback.textContent = msg;
      feedback.hidden = !show;
    };

    setFeedback('Mulai dengan menuliskan kebutuhan Anda.');

    const DISABLED_LOCATION_VALUES = new Set([
      '', '-', '—', 'unknown', 'anywhere', 'n/a', 'not specified', 'none'
    ]);

    const buildLocationLink = (rawLocation) => {
      if (typeof rawLocation !== 'string') return null;
      const trimmed = rawLocation.trim();
      if (!trimmed) return null;
      if (DISABLED_LOCATION_VALUES.has(trimmed.toLowerCase())) return null;

      const coordsMatch = trimmed.match(/(-?\d+(?:\.\d+)?)[,\s]+(-?\d+(?:\.\d+)?)/);
      const query = coordsMatch ? `${coordsMatch[1]},${coordsMatch[2]}` : trimmed;
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
      return { text: trimmed, url };
    };

    const showIntent = (intent, userLoc = null, userPrompt = '') => {
      intentBox.innerHTML = '';
      if (!intent || typeof intent !== 'object') {
        intentBox.hidden = true;
        return;
      }

      intentBox.hidden = false;

      const heading = document.createElement('h2');
      heading.textContent = 'Ringkasan Permintaan';
      intentBox.appendChild(heading);

      const intro = document.createElement('p');
      intro.className = 'intent-intro';
      intro.textContent = userLoc
        ? 'Rekomendasi sudah disesuaikan dengan posisi Anda tanpa mengirim koordinat ke server.'
        : 'Aktifkan izin lokasi browser agar saran lebih relevan dengan posisi Anda.';
      intentBox.appendChild(intro);

      const buildRow = (title, content, hint = null) => {
        const row = document.createElement('div');
        row.className = 'intent-row';

        const label = document.createElement('strong');
        label.textContent = title;
        row.appendChild(label);

        if (content && typeof content === 'object' && 'nodeType' in content) {
          row.appendChild(content);
        } else {
          const span = document.createElement('span');
          span.textContent = content ?? '—';
          row.appendChild(span);
        }

        if (hint) {
          const hintNode = document.createElement('small');
          hintNode.textContent = hint;
          row.appendChild(hintNode);
        }

        intentBox.appendChild(row);
      };

      if (userPrompt) {
        buildRow('Permintaan asli Anda', userPrompt);
      }

      const queryText = typeof intent.query === 'string' && intent.query.trim()
        ? intent.query.trim()
        : '—';
      buildRow(
        'Ringkasan AI',
        queryText,
        'Teks ini berasal langsung dari AI dan bisa saja berbahasa asing.'
      );

      const locationLink = buildLocationLink(intent.location ?? '');
      const locationHint = userLoc
        ? 'Digunakan AI sebagai patokan area, sementara hasil tetap diarahkan ke sekitar Anda.'
        : 'Area patokan dari AI. Aktifkan lokasi agar saran lebih mendekati Anda.';

      if (locationLink) {
        const anchor = document.createElement('a');
        anchor.className = 'intent-link';
        anchor.href = locationLink.url;
        anchor.target = '_blank';
        anchor.rel = 'noopener noreferrer';
        anchor.textContent = locationLink.text;
        buildRow('Area patokan', anchor, locationHint);
      } else {
        const locationText = typeof intent.location === 'string' && intent.location.trim()
          ? intent.location.trim()
          : '—';
        buildRow('Area patokan', locationText, locationHint);
      }

      const radiusValue = typeof intent.radius_m === 'number' && !Number.isNaN(intent.radius_m)
        ? `${numberFormatter.format(intent.radius_m)} meter`
        : '—';
      buildRow('Jangkauan pencarian', radiusValue);

      const hasUserCoords = userLoc && Number.isFinite(userLoc.lat) && Number.isFinite(userLoc.lng);
      if (hasUserCoords) {
        const coordsLabel = `${userLoc.lat.toFixed(5)}, ${userLoc.lng.toFixed(5)}`;
        const userLocationLink = buildLocationLink(coordsLabel);
        if (userLocationLink) {
          const anchor = document.createElement('a');
          anchor.className = 'intent-link';
          anchor.href = userLocationLink.url;
          anchor.target = '_blank';
          anchor.rel = 'noopener noreferrer';
          anchor.textContent = coordsLabel;
          buildRow('Lokasi Anda (lokal)', anchor, 'Koordinat hanya tersimpan di perangkat Anda untuk hitung jarak.');
        } else {
          buildRow('Lokasi Anda (lokal)', coordsLabel, 'Koordinat hanya tersimpan di perangkat Anda untuk hitung jarak.');
        }
      } else {
        buildRow('Lokasi Anda', 'Tidak dibagikan', 'Klik izinkan lokasi pada browser bila ingin hasil lebih dekat.');
      }
    };

    // Ambil lokasi user (timeout 10 detik). Jika gagal → null.
    function getUserLocation() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) return resolve(null);
        const opts = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
        navigator.geolocation.getCurrentPosition(
          p => resolve({ lat: p.coords.latitude, lng: p.coords.longitude }),
          () => resolve(null),
          opts
        );
      });
    }

    // Haversine: jarak km garis lurus.
    function haversineKm(a, b) {
      const R = 6371;
      const dLat = (b.lat - a.lat) * Math.PI / 180;
      const dLng = (b.lng - a.lng) * Math.PI / 180;
      const s1 = Math.sin(dLat / 2);
      const s2 = Math.sin(dLng / 2);
      const aa = s1 * s1 + Math.cos(a.lat * Math.PI / 180) * Math.cos(b.lat * Math.PI / 180) * s2 * s2;
      const c = 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1 - aa));
      return R * c;
    }

    // Susun URL Google Maps Directions.
    function buildDirectionsUrl(origin, dest, placeId) {
      if (!dest || !Number.isFinite(dest.lat) || !Number.isFinite(dest.lng)) {
        return null;
      }
      const base = 'https://www.google.com/maps/dir/?api=1';
      const params = new URLSearchParams({
        destination: `${dest.lat},${dest.lng}`,
        travelmode: 'driving'
      });
      if (origin && Number.isFinite(origin.lat) && Number.isFinite(origin.lng)) {
        params.set('origin', `${origin.lat},${origin.lng}`);
      }
      if (placeId) params.set('destination_place_id', placeId);
      return `${base}&${params.toString()}`;
    }

    // Kartu hasil, now support jarak dan tombol Directions per item.
    function createResultCard(place, embedUrl = null, directionsUrl = null, distanceKm = null) {
      const card = document.createElement('article');
      card.className = 'card';

      const title = document.createElement('h3');
      title.textContent = place.name || 'Nama tempat tidak tersedia';
      card.appendChild(title);

      if (place.address) {
        const address = document.createElement('p');
        address.className = 'info';
        address.textContent = place.address;
        card.appendChild(address);
      }

      if (typeof distanceKm === 'number') {
        const dist = document.createElement('p');
        dist.className = 'info';
        dist.textContent = `Perkiraan jarak ${distanceKm.toFixed(1)} km dari lokasi Anda`;
        card.appendChild(dist);
      }

      if (embedUrl) {
        const frameWrapper = document.createElement('div');
        frameWrapper.className = 'map-frame';
        const iframe = document.createElement('iframe');
        iframe.src = embedUrl;
        iframe.loading = 'lazy';
        iframe.referrerPolicy = 'no-referrer-when-downgrade';
        frameWrapper.appendChild(iframe);
        card.appendChild(frameWrapper);
      }

      const actions = document.createElement('div');
      actions.className = 'card-actions';

      if (directionsUrl) {
        const directionsLink = document.createElement('a');
        directionsLink.className = 'map-button';
        directionsLink.href = directionsUrl;
        directionsLink.target = '_blank';
        directionsLink.rel = 'noopener noreferrer';
        directionsLink.textContent = 'Lihat Rute';
        actions.appendChild(directionsLink);
      }

      if (place.maps_url) {
        const mapsLink = document.createElement('a');
        mapsLink.className = 'map-button';
        mapsLink.href = place.maps_url;
        mapsLink.target = '_blank';
        mapsLink.rel = 'noopener noreferrer';
        mapsLink.textContent = 'Buka di Google Maps';
        actions.appendChild(mapsLink);
      }

      if (actions.children.length) {
        card.appendChild(actions);
      }

      return card;
    }

    async function askLLM(prompt, userLoc) {
      const payload = {
        prompt,
        user_lat: userLoc && Number.isFinite(userLoc.lat) ? userLoc.lat : null,
        user_lng: userLoc && Number.isFinite(userLoc.lng) ? userLoc.lng : null,
      };
      const res = await fetch(`${API_BASE}/api/llm/places`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const detail = await res.json().catch(() => ({}));
        const errMsg = detail?.detail
          ? `Permintaan gagal: ${detail.detail}`
          : `Permintaan gagal (kode ${res.status}).`;
        throw new Error(errMsg);
      }
      return res.json();
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const prompt = (promptField.value || '').trim();
      if (!prompt) {
        setFeedback('Mohon isi deskripsi pencarian terlebih dahulu.');
        return;
      }

      setFeedback('Sedang memproses permintaan Anda…');
      resultsContainer.innerHTML = '';
      showIntent(null);

      try {
        const userLoc = await getUserLocation();
        const data = await askLLM(prompt, userLoc);
        showIntent(data?.intent ?? null, userLoc, prompt);

        let places = Array.isArray(data?.places) ? data.places.slice() : [];

        if (!places.length) {
          setFeedback('Permintaan dipahami, tetapi belum ada rekomendasi yang cocok. Coba ubah kata kunci atau radius.');
          return;
        }

        setFeedback('', false);

        if (userLoc && Number.isFinite(userLoc.lat) && Number.isFinite(userLoc.lng)) {
          places = places.map((place) => {
            const destLat = Number(place.lat);
            const destLng = Number(place.lng);
            const hasCoords = Number.isFinite(destLat) && Number.isFinite(destLng);
            return {
              ...place,
              _distanceKm: hasCoords ? haversineKm(userLoc, { lat: destLat, lng: destLng }) : null,
              lat: hasCoords ? destLat : place.lat,
              lng: hasCoords ? destLng : place.lng,
            };
          });

          places.sort((a, b) => {
            const da = typeof a._distanceKm === 'number' ? a._distanceKm : Number.POSITIVE_INFINITY;
            const db = typeof b._distanceKm === 'number' ? b._distanceKm : Number.POSITIVE_INFINITY;
            return da - db;
          });
        }

        places.slice(0, 5).forEach((place, index) => {
          const destLat = Number(place.lat);
          const destLng = Number(place.lng);
          const hasCoords = Number.isFinite(destLat) && Number.isFinite(destLng);
          const dest = hasCoords ? { lat: destLat, lng: destLng } : null;
          const distanceKm = typeof place._distanceKm === 'number' ? place._distanceKm : null;

          // Directions: pakai dari backend untuk item pertama jika ada; selain itu bangun sendiri
          let directions = hasCoords ? buildDirectionsUrl(userLoc, dest, place.place_id) : null;
          if (index === 0 && typeof data?.directions_url === 'string' && data.directions_url.trim()) {
            directions = data.directions_url;
          }

          // Embed: tetap hanya untuk item pertama, mengikuti perilaku sebelumnya
          const embed = index === 0 ? (data?.embed_url ?? null) : null;

          resultsContainer.appendChild(
            createResultCard(place, embed, directions, distanceKm)
          );
        });
      } catch (error) {
        console.error(error);
        setFeedback(error.message || 'Terjadi kendala saat menghubungi layanan AI. Coba lagi beberapa saat lagi.');
      }
    });
  </script>
</body>
</html>
